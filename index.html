<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redwan Text-to-Speech - Multilingual Generator</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Font & Global Styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Light indigo background */
            min-height: 100vh;
        }
        .container-card {
            background-color: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e0e7ff;
        }
        /* Custom Button Styling */
        .speak-button {
            transition: all 0.2s ease-in-out;
            background: linear-gradient(to right, #4c46e4, #6366f1);
            border: none;
        }
        .speak-button:hover:not(:disabled) {
            background: linear-gradient(to right, #3f3baa, #5b5ec8);
            box-shadow: 0 8px 20px rgba(76, 70, 228, 0.4);
            transform: translateY(-1px);
        }
        .speak-button:disabled {
            background-color: #cbd5e1;
            background-image: none;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .loading-ring {
            border: 4px solid #e0e7ff;
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Scrollbar for Textarea */
        textarea::-webkit-scrollbar { width: 6px; }
        textarea::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 3px; }
        textarea::-webkit-scrollbar-track { background-color: #f3f4f6; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="container-card w-full max-w-5xl p-6 md:p-12 rounded-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center justify-center">
                <i data-lucide="mic-2" class="w-8 h-8 mr-3 text-indigo-600"></i>
                Redwan Text-to-Speech
            </h1>
            <p class="text-gray-500 text-lg">Generate ultra-realistic speech using G-TTS.</p>
        </header>

        <!-- Configuration Panel -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            
            <!-- Language Selection -->
            <div>
                <label for="languageSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    Select Language (Locale)
                </label>
                <select id="languageSelect" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-900">
                    <option value="en-US">English (US)</option>
                    <option value="bn-BD">বাংলা (Bangladesh)</option>
                    <option value="hi-IN">हिंदी (India)</option>
                </select>
            </div>

            <!-- Voice Selection -->
            <div>
                <label for="voiceSelect" class="block text-sm font-semibold text-gray-700 mb-2">
                    Select Voice Model
                </label>
                <select id="voiceSelect" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-900">
                    <!-- Options populated dynamically by JS -->
                </select>
            </div>

            <!-- Speed Selection (Updated to input field) -->
            <div>
                <label for="speedInput" class="block text-sm font-semibold text-gray-700 mb-2">
                    Speech Speed/Rate (1.0x - 5.0x)
                </label>
                <input type="text" id="speedInput" value="1.0" placeholder="e.g., 1.3, 2.0" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 text-gray-900">
            </div>


            <!-- Tone/Style Input -->
            <div>
                <label for="styleInput" class="block text-sm font-semibold text-gray-700 mb-2">
                    Speaking Style/Tone (Optional)
                </label>
                <input type="text" id="styleInput" placeholder="e.g., 'cheerfully', 'sadly', 'as a news anchor'" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 bg-gray-50">
            </div>
        </div>

        <!-- Textarea for Input -->
        <label for="textInput" class="block text-sm font-semibold text-gray-700 mb-2">
            Enter Text (Max 2500 characters)
        </label>
        <textarea id="textInput" rows="10" placeholder="Type your text here. The text will be read out in the selected voice and language." maxlength="2500" class="w-full p-5 border border-gray-300 rounded-xl shadow-inner focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 resize-none"></textarea>

        <!-- Action Button and Status -->
        <div class="flex flex-col sm:flex-row items-center justify-between mt-6 space-y-4 sm:space-y-0">
            <button id="speakButton" class="speak-button text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-2xl transition duration-300 w-full sm:w-auto flex items-center justify-center min-w-[280px]">
                <span id="buttonText" class="flex items-center">
                    <i data-lucide="volume-2" class="w-5 h-5 mr-2"></i>
                    Generate & Speak Audio
                </span>
                <div id="loadingIndicator" class="loading-ring hidden"></div>
            </button>

            <!-- Status/Error Message -->
            <div id="statusMessage" class="text-sm font-medium text-gray-600 flex items-center">
                <i data-lucide="info" class="w-4 h-4 mr-1 text-indigo-500"></i>
                Ready to synthesize.
            </div>
        </div>

        <!-- Audio Player -->
        <div id="audioContainer" class="hidden mt-8 bg-indigo-50 p-6 rounded-xl border border-indigo-200">
            <h3 class="text-base font-bold text-indigo-800 mb-3 flex items-center">
                <i data-lucide="waveform" class="w-5 h-5 mr-2"></i>
                Generated Audio Playback (WAV Format)
            </h3>
            <audio id="audioPlayer" controls class="w-full bg-white rounded-lg shadow-md border border-indigo-100"></audio>
            <p class="text-xs text-indigo-700 mt-2">
                *File format is WAV (high quality) only, as Gemini-TTS outputs raw PCM audio.
            </p>
            <a id="downloadLink" href="#" download="redwan_speech.wav" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium block mt-3 underline flex items-center">
                <i data-lucide="download" class="w-4 h-4 mr-1"></i>
                Download Audio (WAV Format)
            </a>
        </div>
        
    </div>

    <!-- Custom Modal for Error/Confirmation -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-3xl max-w-md w-full transform transition-all duration-300 scale-100">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4 flex items-center text-red-600">
                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                Error
            </h3>
            <p id="modalBody" class="text-gray-700 mb-6">An unexpected issue occurred.</p>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-md">Close</button>
        </div>
    </div>


    <script type="text/javascript">
        // --- 1. CONFIGURATION AND VOICE DATA ---
        
        const voiceData = {
            'en-US': [
                { name: 'Zephyr (Bright, Male)', voice: 'Zephyr' },
                { name: 'Kore (Firm, Male)', voice: 'Kore' },
                { name: 'Leda (Youthful, Female)', voice: 'Leda' },
                { name: 'Puck (Upbeat, Male)', voice: 'Puck' },
                { name: 'Zubenelgenubi (Casual, Male)', voice: 'Zubenelgenubi' }
            ],
            'bn-BD': [
                { name: 'Aoede (Breezy, Female)', voice: 'Aoede' },
                { name: 'Achernar (Soft, Female)', voice: 'Achernar' },
                { name: 'Orus (Firm, Male)', voice: 'Orus' },
                { name: 'Despina (Smooth, Female)', voice: 'Despina' }
            ],
            'hi-IN': [
                { name: 'Gacrux (Mature, Male)', voice: 'Gacrux' },
                { name: 'Algenib (Gravelly, Male)', voice: 'Algenib' },
                { name: 'Erinome (Clear, Female)', voice: 'Erinome' },
                { name: 'Laomedeia (Upbeat, Female)', voice: 'Laomedeia' }
            ]
        };

        // --- 2. UI UTILITIES ---

        function showModal(title, message, isError = true) {
            const modal = document.getElementById('modal');
            const titleElement = document.getElementById('modalTitle');
            const icon = isError ? 'alert-triangle' : 'check-circle';
            const color = isError ? 'text-red-600' : 'text-green-600';
            
            titleElement.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 mr-2"></i> ${title}`;
            titleElement.className = `text-2xl font-bold mb-4 flex items-center ${color}`;
            document.getElementById('modalBody').textContent = message;
            modal.classList.remove('hidden');
            lucide.createIcons(); // Re-render icon
        }

        function setStatus(message, isError = false) {
            const statusMessage = document.getElementById('statusMessage');
            const icon = isError ? 'alert-triangle' : 'info';
            const color = isError ? 'text-red-600' : 'text-gray-600';
            
            statusMessage.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 mr-1 ${isError ? 'text-red-500' : 'text-indigo-500'}"></i> ${message}`;
            statusMessage.className = `text-sm font-medium ${color} flex items-center`;
            lucide.createIcons();
        }
        
        function populateVoices(langCode) {
            const voiceSelect = document.getElementById('voiceSelect');
            const voices = voiceData[langCode];

            // Clear existing options
            voiceSelect.innerHTML = ''; 

            if (voices) {
                voices.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.voice;
                    option.textContent = v.name;
                    voiceSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = 'No voices available';
                voiceSelect.appendChild(option);
            }
        }
        
        // --- 3. CORE API AND AUDIO LOGIC ---

        /**
         * Converts raw Base64 PCM 16-bit data to ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Converts raw Int16Array PCM data into a playable WAV Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            let offset = 0;
            
            // RIFF chunk descriptor
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + pcm16.length * bytesPerSample, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;

            // fmt sub-chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, numChannels * sampleRate * bytesPerSample, true); offset += 4;
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            view.setUint16(offset, 8 * bytesPerSample, true); offset += 2;

            // data sub-chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, pcm16.length * bytesPerSample, true); offset += 4;

            // Write the PCM data (Int16, little-endian)
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset + i * bytesPerSample, pcm16[i], true);
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        /**
         * Generates speech audio data by sending text, voice, style, and speed instruction to the API.
         * @param {string} text - The text to synthesize.
         * @param {string} voiceName - The voice model name (e.g., 'Kore').
         * @param {string} style - Natural language tone/style (e.g., 'cheerfully').
         * @param {string} speedPhrase - Natural language speed instruction (e.g., 'quickly', 'at a very fast pace', or '').
         */
        async function generateSpeech(text, voiceName, style, speedPhrase) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            // --- Constructing the User Prompt based on Style and Speed ---
            let userPrompt = text;
            let stylePhrase = style && style.trim() ? `${style.trim()}` : ''; 
            // speedPhrase is already calculated based on user input
            
            const phrases = [];
            if (stylePhrase) phrases.push(stylePhrase);
            if (speedPhrase) phrases.push(speedPhrase);
            
            // Combine phrases into the prompt
            if (phrases.length > 0) {
                const combinedPhrase = phrases.join(' and '); // e.g., 'cheerfully and quickly'
                userPrompt = `Say ${combinedPhrase}: ${text}`;
            } else {
                userPrompt = `Say: ${text}`;
            }
            // --- End Prompt Construction ---


            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            let retryCount = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        retryCount++;
                        const delay = initialDelay * Math.pow(2, retryCount);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${errorData.error?.message || 'Unknown API Error'}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const match = mimeType.match(/rate=(\d+)/);
                        const sampleRate = match ? parseInt(match[1], 10) : 24000; 
                        return { audioData, sampleRate };
                    } else {
                        throw new Error("Received incorrect or missing audio data from the API.");
                    }

                } catch (error) {
                    if (retryCount >= maxRetries - 1) { throw error; } 
                    retryCount++;
                    const delay = initialDelay * Math.pow(2, retryCount);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- 4. EVENT HANDLERS ---
        
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            const langCode = e.target.value;
            populateVoices(langCode);
        });
        
        document.getElementById('speakButton').addEventListener('click', async () => {
            const textInput = document.getElementById('textInput');
            const voiceSelect = document.getElementById('voiceSelect');
            const speedInput = document.getElementById('speedInput'); // Updated element ID
            const styleInput = document.getElementById('styleInput');
            const speakButton = document.getElementById('speakButton');
            const buttonText = document.getElementById('buttonText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const audioContainer = document.getElementById('audioContainer');
            const audioPlayer = document.getElementById('audioPlayer');
            const downloadLink = document.getElementById('downloadLink');

            const text = textInput.value.trim();
            const voiceName = voiceSelect.value;
            const style = styleInput.value.trim();
            const speedValue = speedInput.value.trim(); // Get raw value

            audioContainer.classList.add('hidden');
            audioPlayer.src = '';
            
            if (!text) {
                showModal('Input Required', 'Please enter some text to synthesize.', true);
                setStatus('Input field is empty. Please enter text.', true);
                return;
            }

            // --- Speed Validation and Mapping ---
            let speedPhrase = '';
            const speed = parseFloat(speedValue);

            if (isNaN(speed) || speed < 1.0 || speed > 5.0) {
                showModal('Invalid Speed Input', 'Please enter a numerical speed multiplier between 1.0 and 5.0 (e.g., 1.5).', true);
                setStatus('Invalid speed input. Please check the value.', true);
                // Re-enable button immediately on input error
                speakButton.disabled = false;
                buttonText.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                return;
            }

            if (speed > 1.0 && speed <= 2.0) {
                speedPhrase = 'quickly';
            } else if (speed > 2.0 && speed <= 3.5) {
                speedPhrase = 'at a faster pace';
            } else if (speed > 3.5 && speed <= 5.0) {
                speedPhrase = 'at a very fast pace';
            } 
            // If speed is 1.0, speedPhrase remains empty, resulting in a normal pace.
            // --- End Speed Validation and Mapping ---
            
            // UX: Disable button and show loading
            speakButton.disabled = true;
            buttonText.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            setStatus('Synthesis in progress... Please wait.', false);


            try {
                // 1. Generate Speech via API
                // Pass the determined natural language speed phrase
                const { audioData: base64AudioData, sampleRate } = await generateSpeech(text, voiceName, style, speedPhrase); 

                // 2. Decode and Convert
                const pcmBuffer = base64ToArrayBuffer(base64AudioData);
                const pcm16 = new Int16Array(pcmBuffer);

                // 3. Create WAV Blob
                const wavBlob = pcmToWav(pcm16, sampleRate);
                
                // 4. Update UI
                const audioUrl = URL.createObjectURL(wavBlob);
                audioPlayer.src = audioUrl;
                downloadLink.href = audioUrl;
                audioContainer.classList.remove('hidden');
                
                setStatus('Audio generation successful. Ready for playback.', false);

            } catch (error) {
                console.error("TTS Process Error:", error);
                setStatus(`Error: ${error.message}`, true);
                showModal('TTS Generation Error', `Audio synthesis failed: ${error.message}`, true);
            } finally {
                // UX: Re-enable button and hide loading
                speakButton.disabled = false;
                buttonText.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                lucide.createIcons();
            }
        });

        // --- 5. INITIALIZATION ---
        window.onload = () => {
            // 1. Initialize icons
            lucide.createIcons();
            // 2. Populate voices for the default language (en-US)
            populateVoices('en-US');
            // 3. Set initial status
            setStatus('Ready to synthesize.');
        }

    </script>
</body>
</html>